<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="color-scheme" content="dark" />
  <title>TruthVerify — Verification Record</title>
  <style>
    :root{
      --bg:#07080b; --border:rgba(255,255,255,.10);
      --text:rgba(255,255,255,.92); --muted:rgba(255,255,255,.65);
      --good:#58d08a; --warn:#f7c35f;
    }
    body{margin:0;background:var(--bg);color:var(--text);font-family:system-ui}
    .wrap{max-width:820px;margin:0 auto;padding:22px 16px 70px}
    .card{margin-top:14px;border:1px solid var(--border);border-radius:18px;background:rgba(255,255,255,.04);padding:16px}
    .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono",monospace}
    .pill{display:inline-flex;gap:8px;align-items:center;padding:7px 10px;border-radius:999px;border:1px solid rgba(255,255,255,.12);background:rgba(255,255,255,.03);font-size:12px;color:var(--muted)}
    .status.ok{color:var(--good)}
    .status.pending{color:var(--warn)}
    .kv{display:grid;grid-template-columns:160px 1fr;gap:8px 10px;margin-top:12px}
    @media(max-width:700px){.kv{grid-template-columns:1fr}}
    .kv div{padding:10px;border:1px solid rgba(255,255,255,.08);border-radius:14px;background:rgba(255,255,255,.02);word-break:break-word}
  .btnRow{display:flex;gap:10px;flex-wrap:wrap;margin-top:12px}
.btn{
  appearance:none;
  border:1px solid rgba(255,255,255,.14);
  background:rgba(255,255,255,.06);
  color:var(--text);
  padding:10px 12px;
  border-radius:14px;
  font-size:13px;
  cursor:pointer;
}
.btn:active{transform:scale(.99)}
.badgeWrap{display:flex;gap:14px;align-items:flex-start;flex-wrap:wrap}
.badgePreview{
  border:1px solid rgba(255,255,255,.10);
  background:rgba(0,0,0,.25);
  border-radius:16px;
  padding:12px;
  width:min(360px,100%);
}
.small{
  color:var(--muted);
  font-size:12px;
  margin-top:8px;
  line-height:1.35;
}
  </style>
</head>
<body>
<div class="wrap">
  <div style="display:flex;justify-content:space-between;gap:10px;flex-wrap:wrap;">
    <div>
      <h2 style="margin:0 0 6px;">Verification record</h2>
      <div class="pill">Badge ID: <span class="mono" id="badgeId"></span></div>
    </div>
    <div style="display:flex;gap:10px;">
      <a class="pill" href="./">/v Dashboard</a>
      <a class="pill" href="../">Home</a>
    </div>
  </div>

  <div class="card" id="state">Loading…</div>
  <div class="card" id="details" style="display:none;"></div>
  <div class="card" id="downloads" style="display:none;"></div>
</div>

<script>
  const id = new URLSearchParams(location.search).get("id");
  document.getElementById("badgeId").textContent = id || "(missing)";
  
  // --- Badge SVG (dark/gold minimal) ---
  function badgeSVG(rec, id){
    const creator = (rec.creator_name || rec.creator || rec.creatorName || "TruthVerify").toString();
    const status = (rec.status || "pending").toString().toLowerCase();
    const statusLabel = status === "verified" ? "Verified" : (status === "revoked" ? "Revoked" : "Pending");

    const pillColor = status === "verified" ? "#58d08a" : (status === "revoked" ? "#ff6b6b" : "#f7c35f");

    // Safe shorten for display
    const badgeId = (id || rec.id || rec.badge || rec.badgeId || "TV-????").toString();

    return `
<svg xmlns="http://www.w3.org/2000/svg" width="1200" height="630" viewBox="0 0 1200 630">
  <defs>
    <linearGradient id="g" x1="0" x2="1" y1="0" y2="1">
      <stop offset="0" stop-color="#0b0c10"/>
      <stop offset="1" stop-color="#07080b"/>
    </linearGradient>
    <radialGradient id="glow" cx="30%" cy="20%" r="60%">
      <stop offset="0" stop-color="rgba(215,184,90,.22)"/>
      <stop offset="1" stop-color="rgba(215,184,90,0)"/>
    </radialGradient>
  </defs>

  <rect width="1200" height="630" fill="url(#g)"/>
  <rect width="1200" height="630" fill="url(#glow)"/>

  <rect x="70" y="70" width="1060" height="490" rx="34"
        fill="rgba(255,255,255,.03)" stroke="rgba(255,255,255,.10)" />

  <rect x="110" y="120" width="240" height="54" rx="27"
        fill="rgba(0,0,0,.35)" stroke="rgba(255,255,255,.12)"/>
  <circle cx="140" cy="147" r="8" fill="${pillColor}"/>
  <text x="160" y="154" fill="rgba(255,255,255,.88)" font-size="22" font-family="system-ui, -apple-system, Segoe UI">
    TruthVerify • ${statusLabel}
  </text>

  <text x="110" y="250" fill="rgba(255,255,255,.92)" font-size="60"
        font-family="system-ui, -apple-system, Segoe UI" font-weight="650">
    ${escapeXml(creator)}
  </text>

  <text x="110" y="318" fill="rgba(215,184,90,.95)" font-size="34"
        font-family="ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace">
    ${escapeXml(badgeId)}
  </text>

  <text x="110" y="390" fill="rgba(255,255,255,.65)" font-size="22"
        font-family="system-ui, -apple-system, Segoe UI">
    Public verification record
  </text>

  <text x="110" y="520" fill="rgba(255,255,255,.45)" font-size="18"
        font-family="ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace">
    kungbirdmed.github.io/truthverify-site/v/verify.html?id=${escapeXml(badgeId)}
  </text>
</svg>`;
  }

  function escapeXml(s){
    return (s ?? "").toString()
      .replaceAll("&","&amp;")
      .replaceAll("<","&lt;")
      .replaceAll(">","&gt;")
      .replaceAll('"',"&quot;")
      .replaceAll("'","&apos;");
  }

  // --- Convert SVG -> PNG blob (iPhone-safe) ---
  async function svgToPngBlob(svgText, w=1200, h=630){
    const svgDataUrl = "data:image/svg+xml;charset=utf-8," + encodeURIComponent(svgText);

    const img = new Image();
    img.decoding = "async";
    img.src = svgDataUrl;

    await new Promise((resolve, reject) => {
      img.onload = resolve;
      img.onerror = reject;
    });

    const canvas = document.createElement("canvas");
    canvas.width = w;
    canvas.height = h;

    const ctx = canvas.getContext("2d");
    // background (avoid transparent)
    ctx.fillStyle = "#07080b";
    ctx.fillRect(0,0,w,h);
    ctx.drawImage(img, 0, 0, w, h);

    return await new Promise((resolve) => {
      canvas.toBlob((blob) => resolve(blob), "image/png", 0.95);
    });
  }

  // --- iOS-friendly “download”: open blob in new tab, user uses Share sheet ---
  function openBlobInNewTab(blob, filename){
    const url = URL.createObjectURL(blob);

    // iOS Safari often ignores <a download>, so we open a new tab instead.
    const win = window.open(url, "_blank");
    if(!win){
      // popup blocked; fallback
      location.href = url;
    }

    // revoke later
    setTimeout(() => URL.revokeObjectURL(url), 60_000);
  }

  // --- PDF: open print-friendly page (user: Share/Print -> Save to Files as PDF) ---
  function openPrintPDF(svgText, title){
    const html = `
<!doctype html>
<html>
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>${escapeXml(title || "TruthVerify Badge")}</title>
  <style>
    body{ margin:0; padding:24px; font-family: system-ui; background:#fff; }
    .wrap{ max-width:900px; margin:0 auto; }
    .note{ margin: 0 0 14px; color:#333; font-size:14px; }
    svg{ width:100%; height:auto; display:block; }
    @media print { .note{ display:none; } body{ padding:0; } }
  </style>
</head>
<body>
  <div class="wrap">
    <p class="note">iPhone: Tap Share → Print → pinch-out preview → Share → Save to Files (PDF).</p>
    ${svgText}
  </div>
  <script>
    setTimeout(() => window.print(), 300);
  <\/script>
</body>
</html>`;
    const blob = new Blob([html], {type:"text/html"});
    openBlobInNewTab(blob, (title || "badge") + ".html");
  }

  // --- The function your page is calling ---
  function setupDownloads(rec, id){
    const btnPng = document.getElementById("dlPng");
    const btnPdf = document.getElementById("dlPdf");
    if(!btnPng || !btnPdf) return;

    const badgeId = id || rec.id || rec.badge || rec.badgeId || "TV-UNKNOWN";
    const creator = rec.creator_name || rec.creator || rec.creatorName || "TruthVerify";
    const fileBase = `${badgeId}`.replaceAll(/[^\w\-]+/g, "_");

    btnPng.onclick = async () => {
      try{
        const svg = badgeSVG(rec, badgeId);
        const pngBlob = await svgToPngBlob(svg, 1200, 630);
        if(!pngBlob) throw new Error("PNG export failed.");
        openBlobInNewTab(pngBlob, `${fileBase}.png`);
      }catch(err){
        console.warn(err);
        alert("PNG export failed on this device. Try again, or use the PDF/Print option.");
      }
    };

    btnPdf.onclick = () => {
      try{
        const svg = badgeSVG(rec, badgeId);
        openPrintPDF(svg, `${creator} • ${badgeId}`);
      }catch(err){
        console.warn(err);
        alert("PDF export failed. Try again.");
      }
    };
  }
<

  async function load(){
    try{
      const res = await fetch("./data.json", {cache:"no-store"});
      const data = await res.json();
      const rec = (data.records || data).find(r => (r.badge || r.badgeId || r.id) === id);

      const state = document.getElementById("state");
      const details = document.getElementById("details");

      if(!rec){
        state.innerHTML = "<b>Not found.</b><div style='color:rgba(255,255,255,.65);margin-top:6px;'>Badge ID not in public dataset.</div>";
        return;
      }

      const status = (rec.status || "pending").toLowerCase();
      state.innerHTML = `<b>Status:</b> <span class="status ${status}">${rec.status}</span>`;

      const rows = [
  ["Creator", rec.creator_name || rec.creator || rec.creatorName || "—"],
  ["Handle", rec.handle || "—"],
  ["Platform", rec.platform || "—"],
  ["Issued", rec.issued_at || "—"],
  ["Expires", rec.expires_at || "—"],
  ["Notes", rec.notes || "—"]
];


      details.style.display = "block";
      details.innerHTML = `<div class="kv">${
        rows.map(([k,v])=>`<div><b>${k}</b></div><div class="mono">${v ?? "—"}</div>`).join("")
      }</div>`;
      try { setupDownloads?.(rec, id); } catch (err) { console.warn("downloads error", err); }
    }catch(e){
      document.getElementById("state").textContent = "Failed to load verification record.";
    }
  }
  function setupDownloads(rec, id){
  if ((rec.status || "").toLowerCase() !== "verified") return;

  const el = document.getElementById("downloads");
  if (!el) return;

  el.style.display = "block";
  el.innerHTML = `
    <div class="badgeWrap">
      <div class="badgePreview">
        <div class="pill">TruthVerify • Verified</div>
        <h3 style="margin:10px 0 4px;">${rec.creator_name || rec.creator || "Verified Creator"}</h3>
        <div class="mono">${id}</div>
        <div class="small">Public verification record</div>
      </div>

      <div>
        <div class="btnRow">
          <button class="btn" id="dlPng">Download PNG</button>
          <button class="btn" id="dlPdf">Download PDF</button>
        </div>
        <div class="small">
          Use this badge on TikTok, bio links, or websites.
        </div>
      </div>
    </div>
  `;

  document.getElementById("dlPng").onclick = () => { downloadPNG(rec, id); };
  document.getElementById("dlPdf").onclick = () => { downloadPDF(rec, id); };
}
  load();
</script>
</body>
</html>